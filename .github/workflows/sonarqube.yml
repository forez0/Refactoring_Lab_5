name: SonarQube Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  sonar-analysis:
    runs-on: ubuntu-latest
    services:
      sonarqube:
        image: sonarqube:9.9-community
        ports:
          - 9000:9000
        options: >-
          --health-cmd="curl -f http://localhost:9000/api/system/health || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"

    env:
      SONAR_HOST_URL: http://sonarqube:9000
      SONAR_PROJECT_KEY: library_service_key
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Wait for SonarQube to be ready
      run: |
        echo "Waiting for SonarQube to be ready..."
        for i in {1..30}; do
          STATUS=$(curl -s http://localhost:9000/api/system/health | jq -r '.health')
          if [ "$STATUS" == "GREEN" ]; then
            echo "SonarQube is ready!"
            break
          fi
          echo "Status: $STATUS, waiting..."
          sleep 5
        done

    - name: Build custom SonarScanner image
      run: |
        docker build -t custom-sonarscanner -f sonar-scanner.Dockerfile .

    - name: Run SonarScanner in Docker
      run: |
        docker run --rm \
          --network=host \
          -e SONAR_HOST_URL=$SONAR_HOST_URL \
          -e SONAR_TOKEN=$SONAR_TOKEN \
          -e SONAR_PROJECT_KEY=$SONAR_PROJECT_KEY \
          -v "$PWD:/usr/src" \
          custom-sonarscanner

    - name: Fetch coverage via API
      run: |
        sleep 10
        curl -s "$SONAR_HOST_URL/api/measures/component?component=$SONAR_PROJECT_KEY&metricKeys=coverage" \
          | jq -r '.component.measures[0].value' > coverage.txt

    - name: Read and export coverage
      id: coverage
      run: |
        COVERAGE=$(cat coverage.txt)
        echo "code_coverage=$COVERAGE" >> $GITHUB_ENV
        echo "Coverage is $COVERAGE%"

    - name: Conditional pass/fail by coverage
      if: ${{ env.code_coverage >= 30 }}
      run: echo "✅ Coverage OK"

    - name: Fail if coverage too low
      if: ${{ env.code_coverage < 30 }}
      run: |
        echo "❌ Coverage too low: ${{ env.code_coverage }}%"
        exit 1
